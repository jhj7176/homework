
<%@page import="java.sql.DriverManager"%>
<%@ page language="java" contentType="text/html; charset=EUC-KR"
	pageEncoding="EUC-KR"%>
<!DOCTYPE html>
<html>
<head>
<meta charset="EUC-KR">
<title>Insert title here</title>
</head>
<body>
	<%@ include file="../template/header.jspf"%>
	<%
		int ref = Integer.parseInt(request.getParameter("ref"));
	int no = Integer.parseInt(request.getParameter("no"));
	int lev = Integer.parseInt(request.getParameter("lev"));
	System.out.println("check:" + ref + "," + no + "," + lev);
	String title = request.getParameter("title");
	String writer =request.getParameter("writer");
	String content =request.getParameter("content");
	System.out.println("check:" + title + "," + writer);

	try {
		String back = request.getParameter("back");
		if (back.equals("글목록")) {
			response.sendRedirect("list.jsp");
			return;
		}
	} catch (Exception e) {
		//e.printStackTrace();
	}

	try {
		conn = DriverManager.getConnection(url, info);
			stmt = conn.createStatement();

		String sql = "insert into notice (num, title, writer, wtime, content, ref, no, lev) values (";

		if (lev == 0) {

			sql += "notice_seq.nextval, '" + title + "', '" + writer + "', sysdate, '" + content + "', "+ref+",";
			sql += "(select max(no)+1 from notice where ref =" + ref + ")," + lev + "+1)";
			stmt.executeQuery(sql);
		} else {
			int reNo = 0;
			String sql3 = "select max(no) as maxNo from notice where ref= "+ref+" and lev =" +lev+1;
			stmt.executeQuery(sql);
			if(rs.next()) reNo = rs.getInt("maxNo");//같은 레벨의 대댓글들 중에 가장 큰 번호. 
			
			stmt.close();
			String sql2 = "update notice set no = no+1";
			sql2 += " where ref = " + ref + " and no >" + reNo;
			System.out.println(sql2);
			stmt.executeQuery(sql2);
			stmt.close();

			sql += "notice_seq.nextval, '" + title + "', '" + writer + "', sysdate, '" + content + "', "+ref+",";
			sql += reNo + "+1," + lev + "+1)";
			System.out.println(sql);
			stmt = conn.createStatement();
			stmt.executeQuery(sql);
			
		} //if
	} catch (Exception e) {
		e.printStackTrace();
	} finally {
		if (stmt != null)
			stmt.close();
		if (conn != null)
			conn.close();
		response.sendRedirect("list.jsp");
	}
	%>




</body>
</html>